<!DOCTYPE html>
<html lang="en">
    <head>
        <title>OLAF's Neighbourhood Protocol</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

        <script src="https://cdn.socket.io/4.1.3/socket.io.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" defer></script>

        <!-- <script src="{{ url_for('static', filename='script.js') }}" defer></script>
        <script src="{{ url_for('static', filename='userInitial.js') }}" defer></script> -->
    </head>
    <body>
        <div id="container" class="container-fluid vh-100 d-flex flex-column">
            <h2 id="title">OLAF's Neighbourhood Protocol</h2>
            <div class="row">
                <!-- Dropdown List Users Online and option for group chat message to all users online-->
                <!-- When user selected person messaging to also changes and retreive chat history in current connection -->
                 <div class="dropdown col-6">
                    <button id="dropdownOnlineUsers" class="btn btn-primary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Users Online
                    </button>
                    <ul id="onlineUsersList" class="dropdown-menu w-100" aria-labelledby="dropdownOnlineUsers">
                    </ul>
                 </div>
                 <div class="col-6">
                    <button id="groupChat" class="btn btn-primary w-100" type="submit">
                        Chat in Group
                    </button>
                 </div>
            </div>
            <h5 id="selectedChat">Talking to: None</h5>
            <div id="chatWindowStyle" class="flex-grow-1 d-flex flex-column">
                <div id="chatWindow" class="flex-grow-1 mb-2">
                    <div class="row flex-grow-1 overflow-auto">
                         <ul id="chatHistory">
                         </ul>
                    </div>
                </div>
                <form id="margin" class="d-flex">
                    <input id="messageInput" type="text" class="form-control" placeholder="Send message here..." autocomplete="off">
                    <button id="uploadFiles" class="btn btn-primary" type="button">
                        +
                    </button>
                    <button id="sendButton" class="btn btn-primary" type="submit">
                        Submit
                    </button>
                </form>
            </div>        
        </div>
        <script type="module">
            import { initializeUser } from "{{ url_for('static', filename='userInitial.js') }}";
            const socket = io();

            socket.connect();
            socket.on("connect", () => {
                initializeUser();
                // Request the list of connected clients
                socket.emit("request_connected_clients");
            });

            // Send messages to the server to be broadcasted to all clients
            // Need to write conditional functionality that encrypts the message based on the public key of the selected recipient
            // If public message, no encryption required
            // If multiple recipients, encrypt with each public key and send separate JSON packages
            document.getElementById("margin").addEventListener("submit", (event) => {
                event.preventDefault(); // Prevent default form submission
                const messageInput = document.getElementById("messageInput");
                const message = messageInput.value.trim();
                if (message !== "") {
                    socket.emit("sendMessage", message);
                    messageInput.value = ""; // Clear the input after sending
                }
            });


            // List for chat messages that are broadcasted from the server
            // Need to write conditional functionality that handles incoming messages
            // If decryption successful with private key, message is passed, if not ignore
            socket.on("chat", (data) => {
                let ul = document.getElementById("chatHistory");
                let li = document.createElement("li");
                li.appendChild(document.createTextNode(data["message"]));
                ul.appendChild(li);
                ul.scrollTop = ul.scrollHeight; // Scroll to the bottom
            });
        </script>
    </body>
</html>