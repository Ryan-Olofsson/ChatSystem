<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.1.3/socket.io.min.js" crossorigin="anonymous"></script>

    <!-- <link rel="stylesheet" href="style.css"> -->
    <!-- <script src="script.js" defer></script> -->

    <style>
        .chat-container {
            width: 500px; /* Increased width */
            height: 400px; /* Set a height for the container */
            margin: 20px auto;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            overflow-y: auto; /* Allow scrolling if content exceeds height */
        }
        .chat-box {
            height: 300px; /* Set height for the chat box */
            overflow-y: auto; /* Allow scrolling for chat messages */
        }
        .message-input {
            width: calc(100% - 100px); /* Adjust width to account for button */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-right: 10px; /* Space between input and button */
            display: inline-block; /* Align with button */
        }
        .submit-button {
            width: 80px; /* Fixed width for the button */
            padding: 10px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .submit-button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <ul id="chatHistory" class="chat-box list-group mb-3"></ul>
        <div class="input-group"> <!-- Bootstrap input group for better alignment -->
            <input id="messageInput" type="text" class="form-control message-input" placeholder="Type your message..." /> <!-- Bootstrap form control -->
            <button id="sendButton" class="btn btn-primary submit-button">Send</button> <!-- Bootstrap button -->
        </div>
    </div>
    <script type="module"> import { initializeUser } from "{{ url_for('static', filename='userInitial.js') }}";
        const socket = io();

        socket.connect();
        socket.on("connect", () => {
            initializeUser();
            // const data = await initializeUser();
            // const username = data[0];
            // const public_key = data[1];
            // socket.emit("addUser", {username, public_key});
        });
    

        // Send messages to the server to be broadcasted to all clients
        // Need to write conditional functionality that encrypts the message based on the public key of the selected recipient
        // If public message, no encryption required
        // If multiple recipients, encrypt with each public key and send separate JSON packages
        document.getElementById("sendButton").addEventListener("click", () => {
            const messageInput = document.getElementById("messageInput");
            const message = messageInput.value;
            messageInput.value = "";

            if (message.trim() !== "") { // Check if the message is not empty
                socket.emit("sendMessage", message);
                messageInput.value = "";
            }
        });

        // List for chat messages that are broadcasted from the server
        // Need to write conditional functionality that handles incoming messages
        // If decryption successful with private key, message is passed, if not ignore
        socket.on("chat", (data) => {
            let ul = document.getElementById("chatHistory");
            let li = document.createElement("li");
            li.appendChild(document.createTextNode(data["message"]));
            ul.appendChild(li);
            ul.scrollTop = ul.scrollHeight;
        })
    </script>
</body>
</html>