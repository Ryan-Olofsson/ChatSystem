<!-- Ryan Olofsson a1864245, Tyler Chapman 1851834, Kian Esmailzadeh a1851935 -->
<!DOCTYPE html>
<html lang="en">
    <head>
        <title>OLAF's Neighbourhood Protocol</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

        <script src="https://cdn.socket.io/4.1.3/socket.io.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" defer></script>
        <script type="module" src="{{ url_for('static', filename='userInitial.js') }}"></script>

        <!-- <script src="{{ url_for('static', filename='script.js') }}" defer></script>
        <script src="{{ url_for('static', filename='userInitial.js') }}" defer></script> -->
    </head>
    <script>
    function updateSelectedChat() {
        const dropdown = document.getElementById("onlineUsersDropdown");
        const selectedFingerprint = dropdown.value; // Get the selected value
        const selectedChatElement = document.getElementById("selectedChat");

        if (selectedFingerprint) {
            selectedChatElement.textContent = `Talking to: ${selectedFingerprint}`; // Update the text
        } else {
            selectedChatElement.textContent = "Talking to: None"; // Reset if no selection
        }
        }
    </script>
    <body>
        <div id="container" class="container-fluid vh-100 d-flex flex-column">
            <h2 id="title">OLAF's Neighbourhood Protocol</h2>
            <div class="row">
                <!-- Dropdown List Users Online and option for group chat message to all users online-->
                <!-- When user selected person messaging to also changes and retreive chat history in current connection -->
                <div class="dropdown col-6 d-flex align-items-center">
                    <label for="onlineUsersDropdown">Online Users:</label>
                    <select id="onlineUsersDropdown" onchange="updateSelectedChat()">
                        <option value="" disabled selected>No Online Users</option>
                    </select>
                    <button id="refreshClientsButton" class="btn btn-secondary">
                        <i class="fas fa-sync-alt"></i> <!-- Refresh icon -->
                    </button>
                </div>
                <div class="col-6">
                    <button id="groupChat" class="btn btn-primary w-100" type="submit">
                        Chat in Group
                    </button>
                 </div>
            </div>
            <h5 id="selectedChat">Talking to: None</h5>
            <div id="chatWindowStyle" class="flex-grow-1 d-flex flex-column">
                <div id="chatWindow" class="flex-grow-1 mb-2">
                    <div class="row flex-grow-1 overflow-auto">
                         <ul id="chatHistory">
                         </ul>
                    </div>
                </div>
                <form id="margin" class="d-flex">
                    <input id="messageInput" type="text" class="form-control" placeholder="Send message here..." autocomplete="off">
                    <button id="uploadFiles" class="btn btn-primary" type="button">
                        Upload File
                    </button>
                    <div id="fileUploadContainer" class="d-none">
                        <input type="file" id="fileInput" />
                        <button id="submitFileUpload" class="btn btn-primary">Upload</button>
                    </div>
                    <button id="sendButton" class="btn btn-primary" type="submit">
                        Submit
                    </button>
                </form>
            </div>        
        </div>
        <script type="module">
            import { initializeUser } from "{{ url_for('static', filename='userInitial.js') }}";
            const socket = io();

            socket.connect();
            socket.on("connect", () => {
                initializeUser();
                // Request the list of connected clients
            });


            // Send messages to the server to be broadcasted to all clients
            // Need to write conditional functionality that encrypts the message based on the public key of the selected recipient
            // If public message, no encryption required
            // If multiple recipients, encrypt with each public key and send separate JSON packages
            document.getElementById("margin").addEventListener("submit", (event) => {
                event.preventDefault(); // Prevent default form submission
                const messageInput = document.getElementById("messageInput");
                const message = messageInput.value.trim();
                if (message !== "") {
                    socket.emit("sendMessage", message);
                    messageInput.value = ""; // Clear the input after sending


                }
            });

            document.getElementById("refreshClientsButton").addEventListener("click", async () => {
                const response = await fetch('/api/get_all_clients'); // Adjust the endpoint as needed
                if (response.ok) {
                    const allClients = await response.json();
                    updateDropdown(allClients);
                } else {
                    console.error("Failed to fetch all clients");
                }
            });

            function updateDropdown(allClients) {
                const dropdown = document.getElementById("onlineUsersDropdown");
                dropdown.innerHTML = ""; // Clear existing options

                const fingerprints = Object.keys(allClients);

                for (let i = 0; i < fingerprints.length; i++) {
                    if (i === 0) continue;
                    

                    const fingerprint = fingerprints[i];
                    const option = document.createElement("option");
                    option.value = fingerprint;
                    option.text = fingerprint; // You can format this as needed
                    dropdown.appendChild(option);
                }
            }

                    // Toggle file upload container visibility
            document.getElementById("uploadFiles").addEventListener("click", () => {
                const container = document.getElementById("fileUploadContainer");
                container.classList.toggle("d-none");
            });

            // Handle file upload
            document.getElementById("submitFileUpload").addEventListener("click", async () => {
                const fileInput = document.getElementById("fileInput");
                const serverUrl = 'http://127.0.0.1:5000';

                if (fileInput.files.length === 0) {
                    alert("Please select a file to upload.");
                    return;
                }

                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('server_url', serverUrl);
                console.log(formData)

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log("File uploaded successfully:", result.file_url);
                    alert("File uploaded successfully!");
                } else {
                    const error = await response.json();
                    console.error("File upload failed:", error);
                    alert("File upload failed.");
                }
            });

            // Function to handle file download
            function downloadFile(fileUrl) {
                const a = document.createElement('a');
                a.href = fileUrl;
                a.download = ''; // You can specify a filename here
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
            // List for chat messages that are broadcasted from the server
            // Need to write conditional functionality that handles incoming messages
            // If decryption successful with private key, message is passed, if not ignore
            socket.on("chat", (data) => {
                let ul = document.getElementById("chatHistory");
                let li = document.createElement("li");
                li.appendChild(document.createTextNode(data["message"]));
                ul.appendChild(li);
                ul.scrollTop = ul.scrollHeight; // Scroll to the bottom
            });
        </script>
    </body>
</html>