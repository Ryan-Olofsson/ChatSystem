<!-- Ryan Olofsson a1864245, Tyler Chapman 1851834, Kian Esmailzadeh a1851935 -->
<!DOCTYPE html>
<html lang="en">
    <head>
        <title>OLAF's Neighbourhood Protocol</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- Link to external CSS files -->
        <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

        <!-- Include Socket.IO and Bootstrap JS -->
        <script src="https://cdn.socket.io/4.1.3/socket.io.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" defer></script>
        <script type="module" src="{{ url_for('static', filename='userInitial.js') }}"></script>
    </head>
    <script>
    // Function to update the selected chat display based on dropdown selection
    function updateSelectedChat() {
        const dropdown = document.getElementById("onlineUsersDropdown");
        const selectedFingerprint = dropdown.value; // Get the selected value
        const selectedChatElement = document.getElementById("selectedChat");

        // Update the chat display based on the selected user
        if (selectedFingerprint === "public") {
            selectedChatElement.textContent = "Talking to: Public Chat"; // Reset if no selection
        } else if (selectedFingerprint) {
            selectedChatElement.textContent = `Talking to: ${selectedFingerprint}`; // Update the text
        } else {
            selectedChatElement.textContent = "Talking to: None"; // Reset if no selection
        }
    }

    // Update the selected chat on page load
    document.addEventListener("DOMContentLoaded", () => {
        updateSelectedChat();
    });
    </script>
    <body>
        <div id="container" class="container-fluid vh-100 d-flex flex-column">
            <h2 id="title">OLAF's Neighbourhood Protocol</h2>
            <div class="row">
                <!-- Dropdown for selecting online users and option for group chat -->
                <div class="dropdown col-6 d-flex align-items-center">
                    <label for="onlineUsersDropdown">Online Users:</label>
                    <select id="onlineUsersDropdown" onchange="updateSelectedChat()">
                        <!-- Option for public chat -->
                        <option value="public">Public Chat</option>
                    </select>
                    <button id="refreshClientsButton" class="btn btn-secondary">
                        <i class="fas fa-sync-alt"></i> <!-- Refresh icon -->
                    </button>
                </div>
                <div class="col-6">
                    <button id="groupChat" class="btn btn-primary w-100" type="submit">
                        Chat in Group
                    </button>
                    <!-- Modal for group chat -->
                    <div class="modal fade" id="groupChatModal" tabindex="-1" aria-labelledby="groupChatModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="groupChatModalLabel">Group Chat</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="groupChatForm">
                                        <div id="recipientsList" class="mb-3">
                                            <!-- Checkboxes for recipients will be dynamically added here -->
                                        </div>
                                        <div class="mb-3">
                                            <textarea id="groupMessageInput" class="form-control" placeholder="Type your message..."></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Send</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <h5 id="selectedChat">Talking to: None</h5>
            <div id="chatWindowStyle" class="flex-grow-1 d-flex flex-column">
                <div id="chatWindow" class="flex-grow-1 mb-2">
                    <div class="row flex-grow-1 overflow-auto">
                         <ul id="chatHistory">
                         </ul>
                    </div>
                </div>
                <div class="d-flex">
                    <input id="messageInput" type="text" class="form-control" placeholder="Send message here..." autocomplete="off">
                    <button id="uploadFiles" class="btn btn-primary" type="button">
                        Upload File
                    </button>
                    <div id="fileUploadContainer" class="d-none">
                        <input type="file" id="fileInput" />
                        <button id="submitFileUpload" class="btn btn-primary">Upload</button>
                    </div>
                    <form id="margin" class="d-flex">
                        <button id="sendButton" class="btn btn-primary" type="submit">
                            Send
                        </button>
                    </form>
                </div>
            </div>        
        </div>
        <script type="module">
            // Import user initialization functions
            import { initializeUser, getUserFingerprint } from "{{ url_for('static', filename='userInitial.js') }}";
            const socket = io(); // Initialize Socket.IO connection

            // Connect to the Socket.IO server
            socket.connect();
            socket.on("connect", async () => {
                await initializeUser(); // Initialize user on connection
                const userFingerprint = getUserFingerprint(); // Get user fingerprint
                console.log("User Fingerprint balls:", userFingerprint);
                // Request the list of connected clients
            });

            // Send messages to the server to be broadcasted to all clients
            document.getElementById("margin").addEventListener("submit", (event) => {
                event.preventDefault(); // Prevent default form submission
                const messageInput = document.getElementById("messageInput");
                const message = messageInput.value.trim();
                const dropdown = document.getElementById("onlineUsersDropdown");
                const selectedFingerprint = dropdown.value;
                const chatHistory = document.getElementById("chatHistory");
                const userFingerprint = getUserFingerprint();
                
                if (message !== "") {
                    let messageType = "Public";
                    let recipientInfo = "";
                    // Emit public or private chat messages based on selection
                    if (selectedFingerprint === "public") {
                        socket.emit("public_chat", {
                            message: message
                        });
                    } else {
                        messageType = "Private";
                        recipientInfo = ` to ${selectedFingerprint.substring(0, 6)}...`;
                        socket.emit("private_chat", {
                            message: message,
                            to: selectedFingerprint,
                            from: userFingerprint
                        });
                    }
                    // Append the message to chat history
                    const li = document.createElement("li");
                    li.textContent = `[${messageType}${recipientInfo}]: ${message}`;
                    chatHistory.appendChild(li);
                    chatHistory.scrollTop = chatHistory.scrollHeight; // Scroll to the bottom
                    messageInput.value = ""; // Clear the input after sending
                }
            });

            // Refresh the list of online clients
            document.getElementById("refreshClientsButton").addEventListener("click", async () => {
                const response = await fetch('/api/get_all_clients'); // Adjust the endpoint as needed
                if (response.ok) {
                    const allClients = await response.json();
                    const userFingerprint = getUserFingerprint();
                    updateDropdown(allClients, userFingerprint); // Update the dropdown with new clients
                } else {
                    console.error("Failed to fetch all clients");
                }
            });

            // Update the dropdown with the list of online clients
            function updateDropdown(allClients, userFingerprint) {
                const dropdown = document.getElementById("onlineUsersDropdown");
                dropdown.innerHTML = ""; // Clear existing options
                const publicOption = document.createElement("option");
                publicOption.value = "public";
                publicOption.text = "Public Chat";
                dropdown.appendChild(publicOption);
                const fingerprints = Object.keys(allClients);
                let hasOptions = false;
                for (let i = 0; i < fingerprints.length; i++) {
                    const fingerprint = fingerprints[i];
                    if (fingerprint === userFingerprint) 
                        continue; // Skip the current user
                    const option = document.createElement("option");
                    option.value = fingerprint;
                    option.text = fingerprint; // You can format this as needed
                    dropdown.appendChild(option);
                    hasOptions = true;
                }
                if (hasOptions) {
                    dropdown.selectedIndex = 0; // Select the first option
                    updateSelectedChat(); // Update the chat display
                }
            }

            // Toggle file upload container visibility
            document.getElementById("uploadFiles").addEventListener("click", () => {
                const container = document.getElementById("fileUploadContainer");
                container.classList.toggle("d-none"); // Show or hide the file upload container
            });

            // Handle file upload
            document.getElementById("submitFileUpload").addEventListener("click", async () => {
                const fileInput = document.getElementById("fileInput");
                const serverUrl = 'http://127.0.0.1:5000';

                if (fileInput.files.length === 0) {
                    alert("Please select a file to upload."); // Alert if no file is selected
                    return;
                }

                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('server_url', serverUrl);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    let url = result.file_url.body.file_url.trim();
                    url = url.replace('./', '');
                    url = url.replace(/ /g, "%20");
                    alert("File uploaded successfully! File URL: " + url); // Alert on successful upload
                } else {
                    const error = await response.json();
                    if (response.status === 413) {
                        alert("File size exceeds the 5 MB limit."); // Alert for file size limit
                    } else {
                        alert("File upload failed."); // Alert for upload failure
                    }
                }
            });

            // Function to handle file download
            function downloadFile(fileUrl) {
                const a = document.createElement('a');
                a.href = fileUrl;
                a.download = ''; // You can specify a filename here
                document.body.appendChild(a);
                a.click(); // Trigger download
                document.body.removeChild(a); // Clean up
            }

            // Listen for incoming chat messages from the server
            socket.on("chat", (data) => {
                let ul = document.getElementById("chatHistory");
                let li = document.createElement("li");
                li.appendChild(document.createTextNode(data["message"])); // Display the message
                ul.appendChild(li);
                ul.scrollTop = ul.scrollHeight; // Scroll to the bottom
            });

            // Open group chat modal and populate recipients list
            document.getElementById("groupChat").addEventListener("click", () => {
                const recipientsList = document.getElementById("recipientsList");
                recipientsList.innerHTML = ""; // Clear existing recipients

                const dropdown = document.getElementById("onlineUsersDropdown");
                const options = dropdown.options;
                for (let i = 0; i < options.length; i++) {
                    const value = options[i].value;
                    if (value && value !== "public") {
                        const checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.value = value;
                        checkbox.id = `recipient-${value}`;

                        const label = document.createElement("label");
                        label.htmlFor = `recipient-${value}`;
                        label.textContent = value;

                        const div = document.createElement("div");
                        div.appendChild(checkbox);
                        div.appendChild(label);
                        recipientsList.appendChild(div); // Add recipient checkboxes
                    }
                }
                const groupChatModal = new bootstrap.Modal(document.getElementById("groupChatModal"));
                groupChatModal.show(); // Show the group chat modal
            });

            // Handle group chat form submission
            document.getElementById("groupChatForm").addEventListener("submit", (event) => {
                event.preventDefault();
                const selectedRecipients = [];
                const checkboxes = document.querySelectorAll("#recipientsList input[type='checkbox']:checked");
                const userFingerprint = getUserFingerprint();
                checkboxes.forEach(checkbox => {
                    selectedRecipients.push(checkbox.value); // Collect selected recipients
                });
                const message = document.getElementById("groupMessageInput").value;
                if (message && selectedRecipients.length > 0) {
                    socket.emit("group_chat", {
                        message: message,
                        recipients: selectedRecipients,
                        from: userFingerprint
                    });
                    const chatHistory = document.getElementById("chatHistory");
                    const li = document.createElement("li");
                    li.textContent = `[Group Chat] ${message}`; // Display group chat message
                    chatHistory.appendChild(li);
                    chatHistory.scrollTop = chatHistory.scrollHeight; // Scroll to the bottom

                    const groupChatModal = bootstrap.Modal.getInstance(document.getElementById("groupChatModal"));
                    groupChatModal.hide(); // Hide the modal after sending
                } else {
                    alert("Please select at least one recipient and enter a message."); // Alert if no recipients or message
                }
            });

        </script>
    </body>
</html>